(function() {
	var uaData = {
		"name":"\u624b\u673a\u54c1\u724c\u5206\u5e03",
		"children":[{"name":"\u82f9\u679c","children":[{"name":"iPhone","value":188709},{"name":"iPad","value":123},{"name":"\u5176\u5b83\u673a\u578b","value":2}],"value":188834},{"name":"\u5176\u5b83\u54c1\u724c","children":[{"name":"\u5176\u5b83\u673a\u578b","value":161448}],"value":161448},{"name":"\u534e\u4e3a","children":[{"name":"\u5176\u5b83\u673a\u578b","value":28222},{"name":"\u534e\u4e3a \u8363\u8000\u7545\u73a94X","value":13617},{"name":"\u534e\u4e3a \u8363\u80006","value":9580},{"name":"\u534e\u4e3a \u8363\u8000\u7545\u73a94C","value":8077},{"name":"\u534e\u4e3a \u8363\u80003C","value":6902},{"name":"\u534e\u4e3a Mate7","value":6081},{"name":"\u534e\u4e3a \u8363\u80006Plus","value":5794},{"name":"\u534e\u4e3a P8 Lite","value":5741},{"name":"\u534e\u4e3a \u8363\u80007","value":5460},{"name":"\u534e\u4e3a \u8363\u8000\u7545\u73a94","value":5082},{"name":"\u534e\u4e3a \u8363\u80004A","value":5050},{"name":"\u534e\u4e3a P8","value":4373},{"name":"\u534e\u4e3a Ascend P7","value":4072},{"name":"\u534e\u4e3a \u8363\u80003X","value":3890},{"name":"\u534e\u4e3a \u9ea6\u82924","value":3836},{"name":"\u534e\u4e3a NXT","value":3053},{"name":"\u534e\u4e3a TAG","value":2299},{"name":"\u534e\u4e3a TIT","value":1967},{"name":"\u534e\u4e3a G610","value":1943},{"name":"\u534e\u4e3a G7","value":1682},{"name":"\u534e\u4e3a ATH","value":1633}],"value":128354},{"name":"\u5c0f\u7c73","children":[{"name":"\u7ea2\u7c73Note","value":25724},{"name":"\u5c0f\u7c734","value":16859},{"name":"\u5c0f\u7c733","value":13995},{"name":"\u5c0f\u7c732","value":11324},{"name":"\u7ea2\u7c73","value":10594},{"name":"\u5c0f\u7c732S","value":9477},{"name":"\u7ea2\u7c732","value":9181},{"name":"\u5c0f\u7c731","value":9022},{"name":"\u5c0f\u7c73Note","value":8351},{"name":"\u7ea2\u7c731S","value":6492},{"name":"\u5c0f\u7c73Pad","value":1340},{"name":"\u5c0f\u7c731S","value":644},{"name":"\u5176\u5b83\u673a\u578b","value":528}],"value":123531},{"name":"\u4e09\u661f","children":[{"name":"\u5176\u5b83\u673a\u578b","value":35192},{"name":"Galaxy Note3","value":9922},{"name":"Galaxy S4","value":6089},{"name":"Galaxy S5","value":5402},{"name":"Galaxy Note2","value":5205},{"name":"Galaxy A7","value":4110},{"name":"Galaxy S3","value":3529},{"name":"Galaxy A5","value":3351},{"name":"Galaxy Grand2","value":3340},{"name":"Galaxy Note4","value":3277},{"name":"Galaxy S6","value":2948},{"name":"Galaxy S6 edge","value":2820},{"name":"Galaxy A8","value":2559},{"name":"Galaxy Grand Prime","value":2212},{"name":"Galaxy Mega Plus","value":2174},{"name":"\u4e09\u661f SM-G928","value":1911},{"name":"Galaxy Trend3","value":1822},{"name":"Galaxy Win Pro","value":1673},{"name":"Galaxy Trend Duos","value":1589},{"name":"Galaxy J5","value":1539},{"name":"Galaxy J7","value":992}],"value":101656},{"name":"Oppo","children":[{"name":"Oppo R7","value":19501},{"name":"\u5176\u5b83\u673a\u578b","value":12787},{"name":"Oppo A31","value":8271},{"name":"Oppo A33","value":4428},{"name":"Oppo 1107","value":3780},{"name":"Oppo R831","value":3399},{"name":"Oppo R7-PLUS","value":2985},{"name":"Oppo R8207","value":2929},{"name":"Oppo A53","value":2626},{"name":"Oppo R7007","value":2210},{"name":"Oppo X9007","value":1924},{"name":"Oppo A11","value":1921},{"name":"Oppo R6007","value":1871},{"name":"Oppo 3007","value":1760},{"name":"Oppo R2017","value":1752},{"name":"Oppo R8007","value":1746},{"name":"Oppo 1105","value":1729},{"name":"Oppo R8107","value":894},{"name":"Oppo N5117","value":831},{"name":"Oppo R8205","value":687},{"name":"Oppo R7005","value":633}],"value":78664},{"name":"Vivo","children":[{"name":"Vivo X5","value":12663},{"name":"\u5176\u5b83\u673a\u578b","value":9076},{"name":"Vivo Y13","value":7164},{"name":"Vivo X6","value":5999},{"name":"Vivo X3","value":3757},{"name":"Vivo Y22","value":3147},{"name":"Vivo Y23","value":2540},{"name":"Vivo Y51","value":2176},{"name":"Vivo Y27","value":2162},{"name":"Vivo Y11","value":2042},{"name":"Vivo Y33","value":1905},{"name":"Vivo Y18","value":1766},{"name":"Vivo Y35","value":1595},{"name":"Vivo Y913","value":1343},{"name":"Vivo X710","value":1191},{"name":"Vivo S7","value":1075},{"name":"Vivo Y17","value":1051},{"name":"Vivo Y37","value":871},{"name":"Vivo XPLAY3","value":861},{"name":"Vivo Y29","value":745},{"name":"Vivo Y28","value":725}],"value":63854},{"name":"\u9177\u6d3e","children":[{"name":"\u5176\u5b83\u673a\u578b","value":12666},{"name":"\u9177\u6d3e 8675","value":4451},{"name":"\u9177\u6d3e 8297","value":3752},{"name":"\u9177\u6d3e 8720","value":1501},{"name":"\u9177\u6d3e 7295","value":1071},{"name":"\u9177\u6d3e 8705","value":909},{"name":"\u9177\u6d3e 8702","value":892},{"name":"\u9177\u6d3e Y75","value":832},{"name":"\u9177\u6d3e 5263","value":708},{"name":"\u9177\u6d3e 8670","value":632},{"name":"\u9177\u6d3e 8712","value":617},{"name":"\u9177\u6d3e 8017","value":609},{"name":"\u9177\u6d3e Y80","value":529},{"name":"\u9177\u6d3e 5891","value":492},{"name":"\u9177\u6d3e 7620","value":448},{"name":"\u9177\u6d3e 8730","value":422},{"name":"\u9177\u6d3e 9190","value":417},{"name":"\u9177\u6d3e 8729","value":355}],"value":31303},{"name":"\u8054\u60f3","children":[{"name":"\u5176\u5b83\u673a\u578b","value":16669},{"name":"\u8054\u60f3 K30","value":1767},{"name":"\u8054\u60f3 A360","value":1486},{"name":"\u8054\u60f3 A3800","value":1272},{"name":"\u8054\u60f3 A788","value":1134},{"name":"\u8054\u60f3 A320","value":1124},{"name":"\u8054\u60f3 A820","value":1089},{"name":"\u8054\u60f3 K50","value":863},{"name":"\u8054\u60f3 A2800","value":696},{"name":"\u8054\u60f3 A850","value":665},{"name":"\u8054\u60f3 A808","value":585},{"name":"\u8054\u60f3 A308","value":458},{"name":"\u8054\u60f3 A368","value":418},{"name":"\u8054\u60f3 S810","value":396}],"value":28622},{"name":"\u9b45\u65cf","children":[{"name":"\u9b45\u65cf MX5","value":6279},{"name":"\u9b45\u65cf MX4","value":4130},{"name":"\u9b45\u65cf M2-NOTE","value":3117},{"name":"\u5176\u5b83\u673a\u578b","value":2842},{"name":"\u9b45\u65cf MX4-PRO","value":2442},{"name":"\u9b45\u65cf M1-METAL","value":2355},{"name":"\u9b45\u65cf M2","value":1248},{"name":"\u9b45\u65cf M040","value":709}],"value":23122},{"name":"HTC","children":[{"name":"\u5176\u5b83\u673a\u578b","value":9717},{"name":"HTC D816T","value":521},{"name":"HTC ONE-X","value":66}],"value":10304},{"name":"\u4e2d\u5174","children":[{"name":"\u5176\u5b83\u673a\u578b","value":9170},{"name":"\u4e2d\u5174 N918","value":516},{"name":"\u4e2d\u5174 Q802","value":512}],"value":10198},{"name":"\u91d1\u7acb","children":[{"name":"\u5176\u5b83\u673a\u578b","value":5197},{"name":"\u91d1\u7acb F103","value":1110},{"name":"\u91d1\u7acb GN151","value":1049},{"name":"\u91d1\u7acb GN5001","value":958},{"name":"\u91d1\u7acb GN9006","value":736},{"name":"\u91d1\u7acb GN9010","value":661},{"name":"\u91d1\u7acb GN9005","value":456}],"value":10167},{"name":"\u6d77\u4fe1","children":[{"name":"\u5176\u5b83\u673a\u578b","value":3310},{"name":"\u6d77\u4fe1 M20","value":1098}],"value":4408},{"name":"TCL","children":[{"name":"\u5176\u5b83\u673a\u578b","value":3684},{"name":"TCL P301M","value":658}],"value":4342},{"name":"Nubia","children":[{"name":"\u5176\u5b83\u673a\u578b","value":1634},{"name":"Nubia NX511J","value":819},{"name":"Nubia NX507J","value":626}],"value":3079},{"name":"\u9524\u5b50","children":[{"name":"\u575a\u679c1","value":1608},{"name":"\u9524\u5b501","value":545},{"name":"\u5176\u5b83\u673a\u578b","value":1}],"value":2154}]
	}
	var container = "#treemap"
	
	var drawZoomTreemap = function() {
        var mouseMoveFunc, mouseOutFunc,isFirstZoom, treemap, svg; 
        var onEvent = d3.dispatch("drawEnd");
        // width = parseInt($(selector).css("width")),
        // height = parseInt($(selector).css("height")),
        var width,height,
        durationtime = 550,
        limit = 0,
        x = d3.scale.linear(),
        y = d3.scale.linear(),
        color = d3.scale.category20();

        function zoomTreemap(b) {
            treemap = d3.layout.treemap()
                .children(function(d, depth) {
                    // 深度为1的没有子节点，即children为null
                    return depth ? null: d._children
                })
                .sort(function(a, b) {
                    return a.value - b.value
                })
                .ratio(height / width * .5 * (1 + Math.sqrt(5))).round(!1);
            x.domain([0, width]).range([0, width]),
            y.domain([0, height]).range([0, height]),
            svg = b,
            svg.attr("width", width).attr("height", height)
        }
        function initData(d) {
            d.x = d.y = 0,
            d.dx = width,
            d.dy = height,
            d.depth = 0
        }
        function getValue(a) {
            return (a._children = a.children) ? a.value = a.children.reduce(function(a, b) {
                return a + getValue(b)
            },
            0) : a.value
        }
        function initZoomData(a) {
            if(a._children) {
                treemap.nodes({
                    _children: a._children
                });
                a._children = a._children.sort(function(a, b) {
                    return b.value < a.value ? -1 : b.value > a.value ? 1 : 0
                });
                a._children.forEach(function(b, order) {
                    b.order = order,
                    b.x = a.x + b.x * a.dx,
                    b.y = a.y + b.y * a.dy,
                    b.dx *= a.dx,
                    b.dy *= a.dy,
                    b.parent = a,
                    initZoomData(b)
                })
            }
        }
        function handleEvent(b) {
            function zoom(a) {
                if (!isFirstZoom && a) {
                    isFirstZoom = true;
                    var b = handleEvent(a),
                    c = d.transition().duration(durationtime),
                    e = b.transition().duration(durationtime);
                    x.domain([a.x, a.x + a.dx]),
                    y.domain([a.y, a.y + a.dy]),
                    svg.style("shape-rendering", null),
                    svg.selectAll(".depth").sort(function(a, b) {
                        return a.depth - b.depth
                    }),
                    b.selectAll("text").style("fill-opacity", 0),
                    c.selectAll("text").call(positionText).style("fill-opacity", 0),
                    e.selectAll("text").call(positionText).style("fill-opacity", 1),
                    c.selectAll("rect").call(position),
                    e.selectAll("rect").call(position),
                    c.remove().each("end",
                    function() {
                        svg.style("shape-rendering", "crispEdges"),
                        isFirstZoom = false
                    })
                }
            }
            var d = svg.insert("g", ".grandparent").datum(b).attr("class", "depth"),
            e = d.selectAll("g").data(b._children).enter().append("g");
            return e.filter(function(a) {
                return a._children
            }).classed("children", !0).on("click", zoom),
            e.selectAll(".child").data(function(a, b) {
                return a._children || [a]
            }).enter().append("rect").attr("class", "child").attr("fill",
            function(a) {
                return color(a.parent.order)
            }).call(position),
            e.append("rect").attr("class", "parent").attr("fill",
            function(a, b) {
                return "undefined" != typeof a._children ? color(b) : void 0
            }).attr("fill-opacity",
            function(a, b) {
                return "undefined" == typeof a._children ? 0 : void 0
            }).on("mousemove", mouseMoveFunc).on("mouseout", mouseOutFunc).call(position),
            e.append("text").attr("dy", ".75em").text(function(a) {
                if(a._children) {
                    return a.dx > (a.name.length)*5 ? (a.dy >= 14 ? a.name : '') : '';
                } else {
                    return a.dx*width/a.parent.dx > (a.name.length)*5 ? (a.dy*height/a.parent.dy >= 14 ? a.name : '') : '';
                }
            }).call(positionText),
            d3.select(selectorCatch).datum(b.parent).on("click", zoom),
            e
        }
        function positionText(a) {
            a.attr("x", function(a) {return x(a.x) + 6})
                .attr("y", function(a) {return y(a.y) + 6});
        }
        function position(d) {
            d.attr("x", function(d) {return x(d.x)})
                .attr("y", function(d) {return y(d.y)})
                .attr("width", function(d) {return x(d.x + d.dx) - x(d.x)})
                .attr("height", function(d) {return y(d.y + d.dy) - y(d.y)});
        }

        zoomTreemap.draw = function(d) {
            initData(d),
            getValue(d),
            initZoomData(d),
            handleEvent(d),
            onEvent.drawEnd()
        };
        zoomTreemap.width = function(arg_width) {
            return arguments.length ? (width = +arg_width, this) : width
        };
        zoomTreemap.height = function(arg_height) {
            return arguments.length ? (height = +arg_height, this) : height
        };
        zoomTreemap.limit = function(arg_limit) {
            return arguments.length ? (limit = +arg_limit, this) : limit
        };
        zoomTreemap.color = function(arg_color) {
            return arguments.length ? (color = arg_color, this) : color
        };
        zoomTreemap.mouseMove = function(func) {
            return arguments.length ? (mouseMoveFunc = func, this) : mouseMoveFunc
        };
        zoomTreemap.mouseOut = function(func) {
            return arguments.length ? (mouseOutFunc = func, this) : mouseOutFunc
        };
        d3.rebind(zoomTreemap, onEvent, "on");
        return zoomTreemap;
    }

    var setColor = function() {


        return d3.scale.ordinal().range(["#179196", "#2EA99C", "#34AFA2", "#2FAB86", "#44B880", "#3EB27A", "#52AE59", "#5FBD44", "#82CB28", "#CEC937", "#D9C53D", "#D5AD20", "#CC9C1A", "#CC8D28", "#B86F20"])
    }

    var tooltipDivID = '';
    var p;
    var dataCatch, selectorCatch;
    var dataOrigin, selectorOrigin;
    var drawTreemap = function(data,selector) {
        dataOrigin = data;
        selectorOrigin = selector;
        p = null;
        dataCatch = {};
        dataCatch['name'] = data['name'];
        dataCatch['children'] = [];
        for(var i = 0; i < data['children'].length; ++i) {
            dataCatch['children'][i] = {};
            dataCatch['children'][i]['name'] = data['children'][i]['name'];
            dataCatch['children'][i]['children'] = [];
            for(var j = 0; j < data['children'][i]['children'].length; ++j) {
                dataCatch['children'][i]['children'][j] = {};
                dataCatch['children'][i]['children'][j]['name'] = data['children'][i]['children'][j]['name'];
                dataCatch['children'][i]['children'][j]['value'] = data['children'][i]['children'][j]['value'];
            }
        }
        selectorCatch = selector;

        $(selector).html('').addClass("dp-treemap");
        var tmp_width = parseInt($(selector).css("width"));
        var tmp_height = parseInt($(selector).css("height"));
        var tmp_left = $(selector).offset().left;
        var tmp_top = $(selector).offset().top;
        p = drawZoomTreemap();
        p.width(tmp_width)
            .height(tmp_height)
            .limit(0.2)
            .color(setColor())
            .mouseMove(function(a) {
                var querySelectorPosition = d3.mouse(document.querySelector(selector));
                if(tooltipDivID == "") {
                    tooltipDivID = $('<div id="messageToolTipDiv" style="position:absolute;display:block;z-index:10000;border:2px solid #E8450C;background-color:#D9D9D9;margin:auto;padding:3px 5px 3px 5px;color:#000;font-size:14px;font-family:arial;border-radius: 5px;vertical-align: middle;text-align: left;min-width:100px;overflow:auto;"></div>');
                    $('body').append(tooltipDivID);
                }
                if(a._children != undefined) {
                    tooltipDivID.html('<span style="color:#f1711d">' + a.name + "</span><br>市场占比：" + (100*a.value/a.parent.value).toFixed(2) + "%")
                    .show()
                    .css({
                        left: tmp_left + querySelectorPosition[0] + (500 - querySelectorPosition[0] > 160 ? 20 : -140),
                        top: tmp_top + querySelectorPosition[1] + 20
                    })
                } else {
                    tooltipDivID.html('<span style="color:#f1711d">' + a.name + "</span><br>品牌内占比：" + (100*a.value/a.parent.value).toFixed(2) + "%<br>市场占比：" + (100*a.value/a.parent.parent.value).toFixed(2) + '%')
                    .show()
                    .css({
                        left: tmp_left + querySelectorPosition[0] + (500 - querySelectorPosition[0] > 160 ? 20 : -140),
                        top: tmp_top + querySelectorPosition[1] + 20
                    })
                }
            })
            .mouseOut(function() {
                tooltipDivID.hide();
            });
        d3.select(selector).append("svg").call(p);
        p.draw(dataCatch);
    }
    drawTreemap(uaData, container);
    $(window).resize(function(){
        drawTreemap(dataOrigin,selectorOrigin);
    });
})();